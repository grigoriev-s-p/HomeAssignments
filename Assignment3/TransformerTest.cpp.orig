/*
 * Sergey Grigoriev
 * st142081@student.spbu.ru
 * fourth task
*/
#include <gtest/gtest.h>
#include "Transformer.h"
#include "Engine.h"
#include "TransformerModel.h"
#include "Autobot.h"
#include "Desepticon.h"
#include "Jettroid.h"
#include <vector>
#include <string>
#include <sstream>

TEST(TransformerTest, ConstructorInitialization) {
    Engine eng(500);
    Transformer* t = new Autobot("Optimus", 10, 200, 50, &eng, 1, true);
    EXPECT_EQ(t->getName(), "Optimus");
    EXPECT_EQ(t->getLevel(), 10);
    EXPECT_EQ(t->getStrength(), 200);
    EXPECT_EQ(t->getAmmo(), 50);
    EXPECT_EQ(t->getEnginePower(), 500);
    EXPECT_EQ(t->getModel(), "standart");
    delete t;
}

TEST(TransformerTest, SettersAndGetters) {
    Engine eng(150);
    Autobot t("Bumblebee", 5, 120, 20, &eng, 1, true);
    t.setName("NewName");
    t.setLevel(7);
    t.setStrength(180);
    t.setAmmo(99);
    EXPECT_EQ(t.getName(), "NewName");
    EXPECT_EQ(t.getLevel(), 7);
    EXPECT_EQ(t.getStrength(), 180);
    EXPECT_EQ(t.getAmmo(), 99);
}

TEST(TransformerTest, EnginePowerChange) {
    Engine eng(300);
    Autobot t("Megatron", 9, 250, 80, &eng, 2, false);
    EXPECT_EQ(t.getEnginePower(), 300);
    t.setEnginePower(900);
    EXPECT_EQ(t.getEnginePower(), 900);
}

TEST(TransformerTest, ModelChange) {
    Engine eng(200);
    Autobot t("Starscream", 6, 170, 60, &eng, 3, false);
    EXPECT_EQ(t.getModel(), "standart");
    t.setModel("jet-mode");
    EXPECT_EQ(t.getModel(), "jet-mode");
}

TEST(TransformerTest, FireAndTransformNoCrash) {
    Engine eng(100);
    Autobot t("Test", 1, 10, 10, &eng, 0, true);
    EXPECT_NO_THROW(t.Fire());
    EXPECT_NO_THROW(t.Transform());
}

TEST(TransformerTest, VirtualMethodsDirectCall) {
    Engine eng(100);
    Autobot a("Optimus", 10, 200, 50, &eng, 1, true);
    Desepticon d("Megatron", 20, 500, 150, &eng, 2, true);
    Jettroid j("SkyJet", 12, 220, 70, &eng, 999, true);

    EXPECT_NO_THROW(a.Transform());
    EXPECT_NO_THROW(a.Fire());
    EXPECT_NO_THROW(a.Fight());
    EXPECT_NO_THROW(a.scan());

    EXPECT_NO_THROW(d.Transform());
    EXPECT_NO_THROW(d.Fire());
    EXPECT_NO_THROW(d.Fight());
    EXPECT_NO_THROW(d.destroy());

    EXPECT_NO_THROW(j.Transform());
    EXPECT_NO_THROW(j.Fire());
    EXPECT_NO_THROW(j.Fight());
    EXPECT_NO_THROW(j.trade());
}

TEST(TransformerTest, VirtualMethodsPointerCall) {
    Engine eng(100);
    Transformer* ptrA = new Autobot("Optimus", 10, 200, 50, &eng, 1, true);
    Transformer* ptrD = new Desepticon("Megatron", 20, 500, 150, &eng, 2, true);
    Transformer* ptrJ = new Jettroid("SkyJet", 12, 220, 70, &eng, 999, true);

    EXPECT_NO_THROW(ptrA->Transform());
    EXPECT_NO_THROW(ptrA->Fire());
    EXPECT_NO_THROW(ptrA->Fight());

    EXPECT_NO_THROW(ptrD->Transform());
    EXPECT_NO_THROW(ptrD->Fire());
    EXPECT_NO_THROW(ptrD->Fight());

    EXPECT_NO_THROW(ptrJ->Transform());
    EXPECT_NO_THROW(ptrJ->Fire());
    EXPECT_NO_THROW(ptrJ->Fight());

    delete ptrA;
    delete ptrD;
    delete ptrJ;
}

TEST(TransformerTest, VirtualMethodsVectorCall) {
    Engine eng(100);
    std::vector<Transformer*> transformers;

    // 3 Autobot
    transformers.push_back(new Autobot("A1", 1, 10, 5, &eng, 1, true));
    transformers.push_back(new Autobot("A2", 2, 20, 5, &eng, 2, false));
    transformers.push_back(new Autobot("A3", 3, 30, 5, &eng, 3, true));

    // 3 Desepticon
    transformers.push_back(new Desepticon("D1", 1, 15, 5, &eng, 1, true));
    transformers.push_back(new Desepticon("D2", 2, 25, 5, &eng, 2, false));
    transformers.push_back(new Desepticon("D3", 3, 35, 5, &eng, 3, true));

    // 3 Jettroid
    transformers.push_back(new Jettroid("J1", 1, 12, 5, &eng, 100, true));
    transformers.push_back(new Jettroid("J2", 2, 22, 5, &eng, 200, false));
    transformers.push_back(new Jettroid("J3", 3, 32, 5, &eng, 300, true));

    for (auto t : transformers) {
        EXPECT_NO_THROW(t->Transform());
        EXPECT_NO_THROW(t->Fire());
        EXPECT_NO_THROW(t->Fight());
    }

    for (auto t : transformers) delete t;
}

TEST(TransformerTest, OutputOperator) {
    Engine eng(100);
    Autobot a("Optimus", 10, 200, 50, &eng, 1, true);
    std::ostringstream oss;
    oss << a;
    std::string output = oss.str();
    EXPECT_NE(output.find("Optimus"), std::string::npos);
}
